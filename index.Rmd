---
title: "Caloosahatchee Water Quality Dashboard"
output: 
  html_document: 
    includes:
      after_body: footer.html
editor_options: 
  chunk_output_type: console
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,warning=FALSE)
```

```{r ,include=F,warning=FALSE}
#Clears Everything...start fresh.
rm(list=ls(all=T));#cat("\014");dev.off()
#Libraries
library(AnalystHelper);#devtools::install_github("SwampThingPaul/AnalystHelper")
library(plyr)
library(reshape)
library(Hmisc)
library(zoo)
library(RcppRoll)
# library(icon);#devtools::install_github("ropenscilabs/icon")
library(kableExtra)
#https://haozhu233.github.io/kableExtra/awesome_table_in_html.html

#Spatial
library(rgeos)
library(rgdal)
library(leaflet)

library(tmap)

# Dates ------------------------------------------------------------------
CurWY=2021
dates=date.fun(c("2010-05-01",paste0(CurWY,"-04-30")))

##
GIS.path="./GIS"

# Spatial Data ------------------------------------------------------------
utm17=CRS("+proj=utm +zone=17 +ellps=GRS80 +towgs84=0,0,0,0,0,0,0 +units=m +no_defs")

counties=spTransform(readOGR(GIS.path,"Florida_Counties"),utm17)
wbids=spTransform(readOGR(GIS.path,"FDEP_WBID_LeeCo"),utm17)
#monitoring=spTransform(readOGR(GIS.path,"Environmental_Monitoring_Stations"),utm17)
cal.planning=spTransform(readOGR(GIS.path,"Caloosa_planning"),utm17)

lee.co=subset(counties,COUNTYNAME=="LEE")
wbids.cal=subset(wbids,WBID%in%c("3240C","3240B","3240A"))
#monitoring.cal=subset(monitoring,STATION%in%c("S79",paste0("CES0",2:8))&ACTIVITY_T=="Chemistry"&ACTIVITY_S=="Surface Water Grab")
#wq.mon=subset(monitoring,ACTIVITY_T=="Chemistry"&ACTIVITY_S=="Surface Water Grab")
#writeOGR(monitoring.cal, GIS.path, "Caloosa_wq", driver="ESRI Shapefile")
#writeOGR(wq.mon, GIS.path, "WMD_wq", driver="ESRI Shapefile")

monitoring.cal=spTransform(readOGR(GIS.path,"Caloosa_wq"),utm17)

tmap_mode("view")

planning.map=tm_basemap(leaflet::providers$Esri.WorldImagery,alpha=0.9)+
  tm_shape(cal.planning)+tm_polygons(col="PLANNING_U",alpha=0.3,title="Planning Units",border.col="white")

map=tm_basemap(leaflet::providers$Esri.WorldImagery,alpha=0.9)+
  tm_shape(subset(counties,COUNTYNAME!="LEE"))+tm_polygons(col="grey",id=NA,alpha=0.75)+
  tm_shape(wbids)+tm_borders("grey50")+
  tm_shape(wbids.cal,is.master = T)+tm_polygons(id="WBID",alpha=0.5,border.col="red")+
  tm_shape(monitoring.cal)+tm_dots(id="STATION",col="dodgerblue",size=0.1)+
  tm_layout(legend.show = F)
  
  
```

***

**_Please note this analysis is for informational purposes only and subject to change._**

*This page is best view in Google Chrome or Firefox.*

```{r, out.width="60%",fig.align="center",echo=FALSE,fig.cap="S-79 lock looking west. *Unknown source*."}
knitr::include_graphics("maxresdefault.jpg")
```


<!--
**Objective(s)**

 -  Provide water quality information specific to the Caloosahatchee River Estuary. 
-->

## Basin Information

The Caloosahatchee Basin in its entirity encompassess aproximately 860 thousand acres (3,470 square kilometers) across three counties (Lee, Hendry and Glades). The Florida Department of Environmental Protection (FDEP) has divided the Caloosahatchee basin into five planning units: East Caloosahatchee, West Caloosahatchee, Orange River, Telegraph Swamp and Caloosahatchee Estuary (Figure 1; Bailey et al. 2009). East and West Caloosahatchee are located upstream of the S-79 structure (see map below) between the S-79 and S-77 (Lake Okeechobee). Meanwhile the Orange River, Telegraph Swamp, and the Caloosahatchee Estuary planning units are located downstream of the S-79 (Figure 2). Each planning unit is composed of a series of sub-basins idenified with waterbody idenfication numbers (WBIDs). All of these sub-basins  except for one are classified as Class III (Designated use: _fishable and swimmable_) water bodies. The exception is the Class I (Designated use: _drinking water_) sub-basin immediately upstream of the S-79 structure (WBID: 3235A) which extends to the Lee-Hendry county line. 

<center>
```{r plan Map,echo=FALSE,message=FALSE,warning=FALSE,out.width="80%"}
tm_basemap(leaflet::providers$Esri.WorldImagery,alpha=0.9)+
  tm_shape(cal.planning)+tm_polygons(col="PLANNING_U",alpha=0.3,title="Planning Units",border.col="white")
```
</center>

<center> __Figure 1:__ Interactive map indicating Caloosahatchee River basins planning units. </center>

## Water Quality Impairments

Water quality impairments in the Tidal Caloosahathcee River and Tributaries were verified as an impaired waterbody due to low Dissolved Oxygen (DO) and high chlorophyll-a (Chl-a) presumably caused by high total nitrogen (TN), total phosphorus (TP) or biochemical oxygen demand (i.e. causative pollutants) concentrations determined during the _Cycle 1_ assessment (2005) (Table 1). Since this inital assessment, these basins have been verified as impaired for un-ionized ammonia (WBID 3240A) and iron (WBIDs 3240B and 3240C) [Verified List](https://floridadep.gov/dear/watershed-assessment-section/documents/verified-list-impaired-waters-group-3-basins-cycle-3){target="_blank"}. Since the _Cycle 1_, _Cylce 2_ and _Cycle 3_ impairment verification assessments and the establishment of the Total Maximum Daily Load (TMDL), estuary numeric nutrient criteria have also been developed specifically for this estuary ([62-302.532(1)(d)](https://www.flrules.org/gateway/RuleNo.asp?title=SURFACE%20WATER%20QUALITY%20STANDARDS&ID=62-302.532){target="_blank"} Florida Administrative Code (FAC), Table 2 below). An interactive map for all FDEP adopted numeric nutrient criteria can be found at this [link](https://ca.dep.state.fl.us/mapdirect/?focus=nutrientcriteria){target="_blank"}.

<br>

```{r tab1 data, echo=F,include=FALSE}
tab1=data.frame(WBID=c("3240A","3240B","3240C"),
               Segment=c("Tidal Caloosahatchee (Lower)","Tidal Caloosahatchee (Middle)","Tidal Caloosahatchee (Upper)"),
               Waterbody.Type=c("Estuary (III)","Estuary (III)","Stream (III)"),
               Parameters.Identified=c(rep("Nutrients (Chl-a)",3)),
               Conc.Impairment=c(paste0("Median TN = ",c(0.83,0.85,1.105),"mg L\u207B\u00B9")))

```

<center> __Table 1:__ Verified impaired parameters identified during _Cycle 1_ Impaired Water Rule assessment by FDEP in 2005 for Tidal Caloosahatchee addressed in the 2009 Total Maximum Daily Load (TMDL; Bailey et al. 2009).</center>

```{r tab1 table, echo=FALSE}
kable(tab1,col.names=c("WBID","Waterbody Segment<br/>","Waterbody<br/> Type","Parameters<br/>Identified","Concentration<br/>Causing<br/>Impairment"),align=c("l",rep("c",4)),escape=F) %>%
  kable_styling(bootstrap_options = "striped", full_width = F) %>%
  footnote(general=" ",
           number=c("Cycle 1 verification period includes data from January 1, 1997 through June 30, 2004."))

```

<br>
<br>


```{r tab2 data , echo=F,include=FALSE}
tab2=data.frame(Estuary.Seg=c("Upper Caloosahatchee River Estuary","Middle Caloosahatchee River Estuary","Lower Caloosahatchee River Estuary"),
                TP=c(0.086,0.055,0.040),
                TN=c(rep("See 62-304.800(2) FAC\u1d47",3)),
                Chla=c(4.2,6.5,5.6))

```

<center> __Table 2:__ Estuary numeric nutrient criteria for the Caloosahatchee River Estuary as identified by 62-302.532(1)(d).</center>

```{r tab2 table, echo=FALSE}
kable(tab2,"html",col.names=c("Estuary/Segment<br/>","Total Phosphorous<br/>(mg L\u207B\u00B9) \u1d43","Total Nitrogen<br/>","Chlorphyll-A<br/>(\u03BCg L\u207B\u00B9) \u1d43"),booktabs=T,align=c("l",rep("c",3)),escape=F) %>%
  kable_styling(bootstrap_options = "striped", full_width = F) %>%
  footnote(escape=F,general=" ",
           alphabet=c("As Long-Term (5-Yr) average.",'<a href=https://www.flrules.org/gateway/ruleNo.asp?id=62-304.800 target="_blank">62-304.800(2)</a>'),
           symbol=c('This information is up-to-date as of April 2019 and is subject to change pending revisions to Florida Administrative Code.<br/>For the most up-to-date information please follow this <a href=https://www.flrules.org/gateway/RuleNo.asp?title=SURFACE%20WATER%20QUALITY%20STANDARDS&ID=62-302.532 target="_blank">link</a>.'))



```

<br>
<br>

<center>
```{r CRE Map,message=FALSE,echo=FALSE,out.width="80%"}
map
```
</center>

<center> __Figure 2:__ Interactive map of monitored locations within Caloosahatchee River Estuary (CRE) relative to sub-basin/Water Body Identification (WBIDs). </center>

```{r wq data,include=FALSE,echo=FALSE}
estuary.site.list=data.frame(Station.ID=c("CES02","CES03","CAL 01","CES04","CAL 03","CES05","CAL 05","CES06","CAL 07","CES07","CAL 09","CES08","CAL 17","S79"),
                     ALIAS=c("CES02",rep("CES03",2),rep("CES04",2),rep("CES05",2),rep("CES06",2),rep("CES07",2),rep("CES08",2),"S79"),
                     WBID=c(rep("3240C",3),rep("3240B",2),rep("3240C",8),NA))
estuary.site.list$CES=ifelse(substring(estuary.site.list$Station.ID,1,3)=="CES"|estuary.site.list$Station.ID=="S79",1,0)
estuary.site.list=subset(estuary.site.list,CES==1)
wq.params=data.frame(Test.Number=c(61,179,21,18,197,25,98,9,8,7,80),param=c("Chla","Chla","TKN","NOx","K_PAR","TP","Sal","SPC","DO","Temp","TN"))
wq.params=subset(wq.params,param%in%c("TP","TN","TKN","NOx","Sal","SPC","DO","Temp","Chla"))


est.dat=data.frame()
for(i in 1:nrow(estuary.site.list)){
tmp=DBHYDRO_WQ(dates[1],dates[2],estuary.site.list$Station.ID[i],wq.params$Test.Number)
est.dat=rbind(est.dat,tmp)
print(i)
}
est.dat=subset(est.dat,Collection.Method=="G")



S79.flow=SFWMD.DBHYDRO.Data.daily(dates[1],dates[2],"00865")
S79.flow$Date.EST=date.fun(S79.flow$Date)
S79.flow$Q.cfs.S79=S79.flow$Data.Value

est.dat$WY=WY(est.dat$Date.EST)
est.dat=merge(est.dat,wq.params,"Test.Number")
est.dat=merge(est.dat,estuary.site.list,"Station.ID")

est.dat.xtab=cast(est.dat,WBID+Station.ID+DateTime.EST+WY~param,value="HalfMDL",mean)
est.dat.xtab$Date.EST=date.fun(est.dat.xtab$DateTime.EST)
est.dat.xtab$TP=est.dat.xtab$TP*1000
est.dat.xtab$TN=with(est.dat.xtab,TN_Combine(NOx,TKN,TN))
est.dat.xtab$Sal.calc=with(est.dat.xtab,round(SalinityCalc(SPC,Temp),2))
est.dat.xtab$DO.persat=with(est.dat.xtab,DO_PerSat(Temp,DO,Sal.calc))
#Predominately feshwater is SPC<4580 (see SFER)
est.dat.xtab$DO.WQS.TOD=with(est.dat.xtab,ifelse(SPC<4580&Station.ID%in%c("S79","CES02"),DO.TOD.WQS.stream(est.dat.xtab$DateTime.EST),42.0));
est.dat.xtab$month=as.numeric(format(est.dat.xtab$Date.EST,"%m"))
est.dat.xtab$season=FL.Hydroseason(est.dat.xtab$Date.EST)
est.dat.xtab=merge(est.dat.xtab,S79.flow[,c("Date.EST","Q.cfs.S79")],all.x=T)

N.scn=cast(est.dat.xtab,Station.ID+WY~season,value="TP",fun.aggregate = function(x) N.obs(x))
N.scn$NTotal=with(N.scn,A_Wet+B_Dry);
N.scn$SeasonScreen=with(N.scn,ifelse(B_Dry>=1&A_Wet>=1,1,0));
N.scn$NScreen=with(N.scn,ifelse(NTotal>=4,1,0));
N.scn$UseData=with(N.scn,ifelse((SeasonScreen+NScreen)==2,"Yes","No"));

est.dat.xtab=merge(est.dat.xtab,N.scn[,c("Station.ID","WY","UseData")],c("Station.ID","WY"))

WY.GM.dat=ddply(est.dat.xtab,c("Station.ID","WY","UseData"),summarise,TP.GM=exp(mean(log(TP),na.rm=T)),TN.GM=exp(mean(log(TN),na.rm=T)),Chla.GM=exp(mean(log(Chla),na.rm=T)),TP.FWM=wtd.mean(TP,Q.cfs.S79,na.rm=T),TN.FWM=wtd.mean(TN,Q.cfs.S79,na.rm=T),mean.DO=mean(DO.persat,na.rm=T),mean.Sal=mean(Sal.calc,na.rm=T),DO.ExceedPer=(sum(DO.persat<DO.WQS.TOD,na.rm=T)/N.obs(DO.persat))*100)
#WY.GM.dat$TP.Cusum=with(WY.GM.dat,ave(TP.GM,Station.ID,FUN=function(test) round(cumsum(base::scale(test)),1)))
WY.GM.dat$LT.AVG.TP=with(WY.GM.dat,ave(TP.GM,Station.ID,FUN=function(x) roll_meanr(x,n=5)))
WY.GM.dat$LT.AVG.TN=with(WY.GM.dat,ave(TN.GM,Station.ID,FUN=function(x) roll_meanr(x,n=5)))
WY.GM.dat$LT.AVG.Chla=with(WY.GM.dat,ave(Chla.GM,Station.ID,FUN=function(x) roll_meanr(x,n=5)))

est.dat.xtab=est.dat.xtab[order(est.dat.xtab$Station.ID,est.dat.xtab$Date.EST),]
```

## Water Quality Data

Presented below is grab sample water quality data (collected approximately monthly) retrieved from the South Florida Water Management online environmental database ([DBHYDRO](http://my.sfwmd.gov/dbhydroplsql/show_dbkey_info.main_menu)). Data presented includes total phosphorus (TP), total nitrogen (TN), chlorophyll-_A_ (Chl-A), dissolved oxygen (DO) and salinity. The top row of plots show individual samples collected across a period of record. The bottom row of plots depict annually average data based on the Florida water (May to April), TP, TN and Chl-A are expressed as geometric mean (GM) concentrations while DO and salinity are expressed as arithmetic mean concentration. In addition to annual GM concentration a five-WY mean is also shown for TP, TN and Chl-A. The dissolved oxygen water quality standard (WQS) is identified for each station and a determination of achievement or exceedance of the WQS for each year is identified. Dissolved Oxygen WQS evaluation is consistent with [62-302.533 FAC](https://www.flrules.org/gateway/RuleNo.asp?title=SURFACE%20WATER%20QUALITY%20STANDARDS&ID=62-302.533) and the associated [technical support document]( https://floridadep.gov/sites/default/files/tsd-do-criteria-aquatic-life.pdf){target="_blank"}.

Each tab presented data from sites along the Caloosahatchee River Estuary including the S-79.


# {.tabset .tabset-fade}

```{r,include=F}
site.val1=c(paste0("CES0",rev(2:8)),"S79")
WBID.title=c(rep("3240A (Lower Caloosahatchee River Estuary)",4),
             "3240B (Middle Caloosahatchee River Estuary)",
             rep("3240C (Upper Caloosahatchee River Estuary)",3))
```

```{r ,results='asis',echo=FALSE,fig.width=10,fig.height=5,fig.align='center' }
for(i in 1:length(site.val1)){
    cat('\n')
    cat("##",site.val1[i],"\n")
    cat(paste("WBID:",WBID.title[i]),"\n")

site.val=site.val1[i]

par(family="serif",mar=c(2.5,2,1,2),oma=c(1,2.5,1,0.1));
layout(matrix(1:10,2,5,byrow=F));

ylim.val=c(10,1000);ymaj=log.scale.fun(ylim.val,"major");ymin=log.scale.fun(ylim.val,"minor")
xlim.val=date.fun(c("2010-05-01",paste0(CurWY,"-05-01")));xmaj=seq(xlim.val[1],xlim.val[2],"6 years");xmin=seq(xlim.val[1],xlim.val[2],"1 years")
plot(TP~Date.EST,est.dat.xtab,ylim=ylim.val,xlim=xlim.val,yaxt="n",xaxt="n",type="n",ylab=NA,xlab=NA,log="y")
abline(h=ymaj,v=xmaj,lty=3,col="grey")
  with(subset(est.dat.xtab,Station.ID==site.val),lines(Date.EST,TP,lty=2,col="grey",lwd=2))
  with(subset(est.dat.xtab,Station.ID==site.val&Q.cfs.S79>0),points(Date.EST,TP,pch=21,bg="dodgerblue1"))
  with(subset(est.dat.xtab,Station.ID==site.val&Q.cfs.S79<=0),points(Date.EST,TP,pch=22,bg="indianred1"))
  axis_fun(1,line=-0.5,xmaj,xmin,format(xmaj,"%m-%Y"),cex=0.9);  axis_fun(2,ymaj,ymin,ymaj);box(lwd=1)
  mtext(side=2,line=2.5,"TP (\u03BCg L\u207B\u00B9)")
  mtext(side=1,line=2,"Date (Month-Year)")
  legend("topleft",legend=c("Q > 0 at S-79","Q = 0 at S-79"),pch=c(21,22),pt.bg=c("dodgerblue1","indianred1"),
       pt.cex=1.5,ncol=1,cex=1,bty="n",y.intersp=1,x.intersp=0.75,xpd=NA,xjust=0.5)

  ylim.val=c(40,200);ymaj=c(50,log.scale.fun(ylim.val,"major"));ymin=log.scale.fun(ylim.val,"minor")
  xlim.val=c(2011,CurWY);by.x=3;xmaj=seq(xlim.val[1],xlim.val[2],by.x);xmin=seq(xlim.val[1],xlim.val[2],by.x/by.x)
  plot(TP.GM~WY,WY.GM.dat,ylim=ylim.val,xlim=xlim.val,yaxt="n",xaxt="n",type="n",ylab=NA,xlab=NA,log="y")
  abline(h=ymaj,v=xmaj,lty=3,col="grey")
  with(subset(WY.GM.dat,Station.ID==site.val),lines(WY,LT.AVG.TP,col="red",lwd=2))
  with(subset(WY.GM.dat,Station.ID==site.val),pt_line(WY,TP.GM,2,"grey",2,21,"olivedrab1",cex=1.25))
  #with(subset(WY.GM.dat,Station.ID==site.val),pt_line(WY,TP.FWM,2,"grey",2,23,"skyblue",cex=1.25))
    axis_fun(1,xmaj,xmin,xmaj,line=-0.5);axis_fun(2,ymaj,ymin,ymaj);box(lwd=1)
  mtext(side=2,line=2.5,"GM TP (\u03BCg L\u207B\u00B9)")
  mtext(side=1,line=2,"Water Year")
  legend("topleft",legend=c("Annual GM","5-WY Mean"),pch=c(21,NA),lty=c(2,1),col=c("grey","red"),lwd=c(1,2),pt.bg=c("olivedrab1",NA),pt.cex=1.5,ncol=1,cex=1,bty="n",y.intersp=1,x.intersp=0.75,xpd=NA,xjust=0.5)

  ylim.val=c(0,5);by.y=1;ymaj=seq(ylim.val[1],ylim.val[2],by.y);ymin=seq(ylim.val[1],ylim.val[2],by.y/2);#;ymaj=log.scale.fun(ylim.val,"major");ymin=log.scale.fun(ylim.val,"minor")
  xlim.val=date.fun(c("2010-05-01",paste0(CurWY,"-05-01")));xmaj=seq(xlim.val[1],xlim.val[2],"6 years");xmin=seq(xlim.val[1],xlim.val[2],"1 years")
  plot(TN~Date.EST,est.dat.xtab,ylim=ylim.val,xlim=xlim.val,yaxt="n",xaxt="n",type="n",ylab=NA,xlab=NA)
  abline(h=ymaj,v=xmaj,lty=3,col="grey")
  with(subset(est.dat.xtab,Station.ID==site.val),lines(Date.EST,TN,lty=2,col="grey",lwd=2))
  with(subset(est.dat.xtab,Station.ID==site.val&Q.cfs.S79>0),points(Date.EST,TN,pch=21,bg="dodgerblue1"))
  with(subset(est.dat.xtab,Station.ID==site.val&Q.cfs.S79<=0),points(Date.EST,TN,pch=22,bg="indianred1"))
  axis_fun(1,line=-0.5,xmaj,xmin,format(xmaj,"%m-%Y"),cex=0.9); axis_fun(2,ymaj,ymin,ymaj);box(lwd=1)
  mtext(side=2,line=2,"TN (mg L\u207B\u00B9)")
  mtext(side=1,line=2,"Date (Month-Year)")
  #legend("topleft",legend=c("Q > 0 at S-79","Q = 0 at S-79"),pch=c(21,22),pt.bg=c("dodgerblue1","indianred1"),
  #       pt.cex=1.5,ncol=1,cex=1,bty="n",y.intersp=1,x.intersp=0.75,xpd=NA,xjust=0.5)
  
  ylim.val=c(0,5);by.y=1;ymaj=seq(ylim.val[1],ylim.val[2],by.y);ymin=seq(ylim.val[1],ylim.val[2],by.y/2);#;ymaj=c(50,log.scale.fun(ylim.val,"major"));ymin=log.scale.fun(ylim.val,"minor")
  xlim.val=c(2011,CurWY);by.x=3;xmaj=seq(xlim.val[1],xlim.val[2],by.x);xmin=seq(xlim.val[1],xlim.val[2],by.x/by.x)
  plot(TP.GM~WY,WY.GM.dat,ylim=ylim.val,xlim=xlim.val,yaxt="n",xaxt="n",type="n",ylab=NA,xlab=NA)
  abline(h=ymaj,v=xmaj,lty=3,col="grey")
  with(subset(WY.GM.dat,Station.ID==site.val),lines(WY,LT.AVG.TN,col="red",lwd=2))
  with(subset(WY.GM.dat,Station.ID==site.val),pt_line(WY,TN.GM,2,"grey",2,21,"olivedrab1",cex=1.25))
  #with(subset(WY.GM.dat,Station.ID==site.val),pt_line(WY,TN.FWM,2,"grey",2,23,"skyblue",cex=1.25))
  axis_fun(1,xmaj,xmin,xmaj,line=-0.5);axis_fun(2,ymaj,ymin,ymaj);box(lwd=1)
  mtext(side=2,line=2,"GM TN (mg L\u207B\u00B9)")
  mtext(side=1,line=2,"Water Year")

  
  ylim.val=c(0,100);by.y=20;ymaj=seq(ylim.val[1],ylim.val[2],by.y);ymin=seq(ylim.val[1],ylim.val[2],by.y/2);#;ymaj=log.scale.fun(ylim.val,"major");ymin=log.scale.fun(ylim.val,"minor")
  xlim.val=date.fun(c("2010-05-01",paste0(CurWY,"-05-01")));xmaj=seq(xlim.val[1],xlim.val[2],"6 years");xmin=seq(xlim.val[1],xlim.val[2],"1 years")
  plot(Chla~Date.EST,est.dat.xtab,ylim=ylim.val,xlim=xlim.val,yaxt="n",xaxt="n",type="n",ylab=NA,xlab=NA)
  abline(h=ymaj,v=xmaj,lty=3,col="grey")
  with(subset(est.dat.xtab,Station.ID==site.val),lines(Date.EST,Chla,lty=2,col="grey",lwd=2))
  with(subset(est.dat.xtab,Station.ID==site.val&Q.cfs.S79>0),points(Date.EST,Chla,pch=21,bg="dodgerblue1"))
  with(subset(est.dat.xtab,Station.ID==site.val&Q.cfs.S79<=0),points(Date.EST,Chla,pch=22,bg="indianred1"))
  axis_fun(1,line=-0.5,xmaj,xmin,format(xmaj,"%m-%Y"),cex=0.9); axis_fun(2,ymaj,ymin,ymaj);box(lwd=1)
  mtext(side=2,line=2.5,"Chlorophyll-A (\u03BCg L\u207B\u00B9)")
  mtext(side=1,line=2,"Date (Month-Year)")
  
  ylim.val=c(0,20);by.y=5;ymaj=seq(ylim.val[1],ylim.val[2],by.y);ymin=seq(ylim.val[1],ylim.val[2],by.y/2);#;ymaj=log.scale.fun(ylim.val,"major");ymin=log.scale.fun(ylim.val,"minor")
  xlim.val=c(2011,CurWY);by.x=3;xmaj=seq(xlim.val[1],xlim.val[2],by.x);xmin=seq(xlim.val[1],xlim.val[2],by.x/by.x)
  plot(Chla.GM~WY,WY.GM.dat,ylim=ylim.val,xlim=xlim.val,yaxt="n",xaxt="n",type="n",ylab=NA,xlab=NA)
  abline(h=ymaj,v=xmaj,lty=3,col="grey")
  with(subset(WY.GM.dat,Station.ID==site.val),lines(WY,LT.AVG.Chla,col="red",lwd=2))
  with(subset(WY.GM.dat,Station.ID==site.val),pt_line(WY,Chla.GM,2,"grey",2,21,"olivedrab1",cex=1.25))
  #with(subset(WY.GM.dat,Station.ID==site.val),pt_line(WY,TP.FWM,2,"grey",2,23,"skyblue",cex=1.25))
  axis_fun(1,xmaj,xmin,xmaj,line=-0.5);axis_fun(2,ymaj,ymin,ymaj);box(lwd=1)
  mtext(side=2,line=2.5,"GM Chl-A (\u03BCg L\u207B\u00B9)")
  mtext(side=1,line=2,"Water Year")
  
  
  ylim.val=c(0,200);by.y=50;ymaj=seq(ylim.val[1],ylim.val[2],by.y);ymin=seq(ylim.val[1],ylim.val[2],by.y/2);#;ymaj=log.scale.fun(ylim.val,"major");ymin=log.scale.fun(ylim.val,"minor")
  xlim.val=date.fun(c("2010-05-01",paste0(CurWY,"-05-01")));xmaj=seq(xlim.val[1],xlim.val[2],"6 years");xmin=seq(xlim.val[1],xlim.val[2],"1 years")
  plot(DO.persat~Date.EST,est.dat.xtab,ylim=ylim.val,xlim=xlim.val,yaxt="n",xaxt="n",type="n",ylab=NA,xlab=NA)
  abline(h=ymaj,v=xmaj,lty=3,col="grey")
  with(subset(est.dat.xtab,Station.ID==site.val),lines(Date.EST,DO.persat,lty=2,col="grey",lwd=2))
  with(subset(est.dat.xtab,Station.ID==site.val&Q.cfs.S79>0),points(Date.EST,DO.persat,pch=21,bg="dodgerblue1"))
  with(subset(est.dat.xtab,Station.ID==site.val&Q.cfs.S79<=0),points(Date.EST,DO.persat,pch=22,bg="indianred1"))
  with(subset(est.dat.xtab,Station.ID==site.val),lines(Date.EST,DO.WQS.TOD,col="red",lty=1,lwd=2))
  axis_fun(1,line=-0.5,xmaj,xmin,format(xmaj,"%m-%Y"),cex=0.9); axis_fun(2,ymaj,ymin,ymaj);box(lwd=1)
  mtext(side=2,line=2.5,"DO (% Sat.)")
  mtext(side=1,line=2,"Date (Month-Year)")
  legend("topleft",legend=c("WQS"),lty=1,lwd=2,col="red",
         ncol=1,cex=1,bty="n",y.intersp=1,x.intersp=0.75,xpd=NA,xjust=0.5)
  
  ylim.val=c(0,200);by.y=50;ymaj=seq(ylim.val[1],ylim.val[2],by.y);ymin=seq(ylim.val[1],ylim.val[2],by.y/2);#;ymaj=c(50,log.scale.fun(ylim.val,"major"));ymin=log.scale.fun(ylim.val,"minor")
  xlim.val=c(2011,CurWY);by.x=3;xmaj=seq(xlim.val[1],xlim.val[2],by.x);xmin=seq(xlim.val[1],xlim.val[2],by.x/by.x)
  plot(mean.DO~WY,WY.GM.dat,ylim=ylim.val,xlim=xlim.val,yaxt="n",xaxt="n",type="n",ylab=NA,xlab=NA)
  abline(h=ymaj,v=xmaj,lty=3,col="grey")
  with(subset(WY.GM.dat,Station.ID==site.val),pt_line(WY,mean.DO,2,"grey",2,21,ifelse(DO.ExceedPer>10,"red","olivedrab1"),cex=ifelse(DO.ExceedPer>10,2,1.25)))
  #with(subset(WY.GM.dat,Station.ID==site.val),pt_line(WY,TN.FWM,2,"grey",2,23,"skyblue",cex=1.25))
  axis_fun(1,xmaj,xmin,xmaj,line=-0.5);axis_fun(2,ymaj,ymin,ymaj);box(lwd=1)
  mtext(side=2,line=2.5,"Mean DO (% Sat.)")
  mtext(side=1,line=2,"Water Year")
  legend("topleft",legend=c("Exceed WQS", "Achieve WQS"),pch=c(21,21),pt.bg=c("red","olivedrab1"),
         pt.cex=c(2,1.25),ncol=1,cex=1,bty="n",y.intersp=1,x.intersp=0.75,xpd=NA,xjust=0.5)

  
  ylim.val=c(0,50);by.y=10;ymaj=seq(ylim.val[1],ylim.val[2],by.y);ymin=seq(ylim.val[1],ylim.val[2],by.y/2);#;ymaj=log.scale.fun(ylim.val,"major");ymin=log.scale.fun(ylim.val,"minor")
  xlim.val=date.fun(c("2010-05-01",paste0(CurWY,"-05-01")));xmaj=seq(xlim.val[1],xlim.val[2],"6 years");xmin=seq(xlim.val[1],xlim.val[2],"1 years")
  plot(Sal.calc~Date.EST,est.dat.xtab,ylim=ylim.val,xlim=xlim.val,yaxt="n",xaxt="n",type="n",ylab=NA,xlab=NA)
  abline(h=ymaj,v=xmaj,lty=3,col="grey")
  with(subset(est.dat.xtab,Station.ID==site.val),lines(Date.EST,Sal.calc,lty=2,col="grey",lwd=2))
  with(subset(est.dat.xtab,Station.ID==site.val&Q.cfs.S79>0),points(Date.EST,Sal.calc,pch=21,bg="dodgerblue1"))
  with(subset(est.dat.xtab,Station.ID==site.val&Q.cfs.S79<=0),points(Date.EST,Sal.calc,pch=22,bg="indianred1"))
  axis_fun(1,line=-0.5,xmaj,xmin,format(xmaj,"%m-%Y"),cex=0.9); axis_fun(2,ymaj,ymin,ymaj);box(lwd=1)
  mtext(side=2,line=2,"Salinity")
  mtext(side=1,line=2,"Date (Month-Year)")
  #legend("topleft",legend=c("Q > 0 at S-79","Q = 0 at S-79"),pch=c(21,22),pt.bg=c("dodgerblue1","indianred1"),
  #       pt.cex=1.5,ncol=1,cex=1,bty="n",y.intersp=1,x.intersp=0.75,xpd=NA,xjust=0.5)
  
  ylim.val=c(0,40);by.y=10;ymaj=seq(ylim.val[1],ylim.val[2],by.y);ymin=seq(ylim.val[1],ylim.val[2],by.y/2);#;ymaj=c(50,log.scale.fun(ylim.val,"major"));ymin=log.scale.fun(ylim.val,"minor")
  xlim.val=c(2011,CurWY);by.x=3;xmaj=seq(xlim.val[1],xlim.val[2],by.x);xmin=seq(xlim.val[1],xlim.val[2],by.x/by.x)
  plot(mean.Sal~WY,WY.GM.dat,ylim=ylim.val,xlim=xlim.val,yaxt="n",xaxt="n",type="n",ylab=NA,xlab=NA)
  abline(h=ymaj,v=xmaj,lty=3,col="grey")
  with(subset(WY.GM.dat,Station.ID==site.val),pt_line(WY,mean.Sal,2,"grey",2,21,"olivedrab1",cex=1.25))
  axis_fun(1,xmaj,xmin,xmaj,line=-0.5);axis_fun(2,ymaj,ymin,ymaj);box(lwd=1)
  mtext(side=2,line=2,"Mean Salinity")
  mtext(side=1,line=2,"Water Year")
  #mtext(side=3,outer=T,site.val[i])

  cat('\n')  

}
```


<br>

#

## Reference

- Bailey, N., W. Magley, J. Mandrup-Poulsen, K O'Donnell, R. Peets (2009) Final TMDL Report. Nutrient TMDL for the Caloosahatchee Estuary (WBIDs 3240A, 3240B and 3240C). Florida Department of Environmental Protection. Tallahassee, Florida. [pdf link](https://floridadep.gov/sites/default/files/tidal-caloosa-nutr-tmdl_0.pdf){target="_blank"}.

